<!DOCTYPE html>
<html lang="en">
<head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="./cookie.js"></script>
    <link rel="stylesheet" href="index.css">
    <title>Game</title>
</head>
<body>
<h3 class="unselectable" style="z-index: 10">Hold left click to draw.
    Press c to clear canvas.</h3>
<canvas id="drawingLayer" width="100" height="100"
        style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
<canvas id="playerLayer" width="100" height="100"
        style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
<script>
    const socket = io();
    socket.on('connect', () => {
        socket.emit('set name', getCookie('name'));
    });

    const radius = 5;
    const pi2 = Math.PI * 2;

    const playerCanvas = document.getElementById('playerLayer');
    const drawingCanvas = document.getElementById('drawingLayer');

    drawingCanvas.width = window.innerWidth;
    drawingCanvas.height = window.innerHeight;
    playerCanvas.width = window.innerWidth;
    playerCanvas.height = window.innerHeight;

    const playerCtx = playerCanvas.getContext("2d");
    const drawingCtx = drawingCanvas.getContext("2d");

    drawingCtx.fillStyle = 'black';
    playerCtx.fillStyle = 'red';

    socket.on('initialize drawing', (drawings) => {
        drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        for (const i in drawings) {
            const p = drawings[i];
            drawingCtx.moveTo(p.x + radius, p.y);
            drawingCtx.fillRect(p.x, p.y, 2, 2);
        }
    });

    socket.on('update drawing', (drawing) => {
        console.log(drawing.x, drawing.y);
        drawingCtx.moveTo(drawing.x + radius, drawing.y);
        drawingCtx.fillRect(drawing.x, drawing.y, 2, 2);
    });

    socket.on('update state', (states) => {
        playerCtx.clearRect(0, 0, playerCanvas.width, playerCanvas.height);
        playerCtx.beginPath();
        for (const i in states) {
            const p = states[i];
            playerCtx.moveTo(p.x + radius, p.y);
            playerCtx.arc(p.x, p.y, radius, 0, pi2);
            playerCtx.fillText(p.name, p.x - 2 * radius - 1.5 * p.name.length, p.y - 2 * radius);
        }
        playerCtx.stroke();
        playerCtx.fill();
    });

    let mouseIntervalId = -1;
    const keysPressed = {}
    document.body.addEventListener('keydown', (e) => {
        keysPressed[e.key] = true;
    });

    document.body.addEventListener('keyup', (e) => {
        delete keysPressed[e.key];
    });

    document.body.addEventListener('mousedown', (e) => {
        if (mouseIntervalId === -1) {
            mouseIntervalId = setInterval(() => {
                socket.emit('action1');
            }, 10);
        } else {
            clearInterval(mouseIntervalId);
            mouseIntervalId = -1;
        }
    })

    document.body.addEventListener('mouseup', (e) => {
        clearInterval(mouseIntervalId);
        mouseIntervalId = -1;
    })

    setInterval(() => {
        for (const i in keysPressed) {
            if (i === 'c') socket.emit('clear drawings');
            if (i === 's') socket.emit('move down');
            else if (i === 'w') socket.emit('move up');
            else if (i === 'a') socket.emit('move left');
            else if (i === 'd') socket.emit('move right');
        }
    }, 10);
</script>
</body>
</html>
