<!DOCTYPE html>
<html lang="en">

<head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="./cookie.js"></script>
    <link rel="stylesheet" href="index.css">
    <title>Game</title>
</head>

<body>
    <h3 class="unselectable" style="z-index: 10">WASD to move.
        Left click to shoot.</h3>
    <canvas id="playerLayer" width="600" height="600" style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
    <canvas id="shotsLayer" width="600" height="600" style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
    <script>
        const socket = io();
        socket.on('connect', () => {
            socket.emit('set name', getCookie('name'));
        });

        const playerRadius = 6;
        const bulletRadius = 2;
        const pi2 = Math.PI * 2;

        const playerCanvas = document.getElementById('playerLayer');
        const shotsCanvas = document.getElementById('shotsLayer');

        const playerCtx = playerCanvas.getContext("2d");
        const shotsCtx = shotsCanvas.getContext("2d");

        playerCtx.fillStyle = 'red';
        socket.on('update player', (states) => requestAnimationFrame(() => {
            playerCtx.beginPath();
            playerCtx.clearRect(0, 0, playerCanvas.width, playerCanvas.height);

            for (const i in states) {
                const p = states[i];

                playerCtx.moveTo(p.x + playerRadius, p.y);
                playerCtx.arc(p.x, p.y, playerRadius, 0, pi2);
                playerCtx.fillText(p.name, p.x - 2 * playerRadius - 1.5 * p.name.length, p.y - 2 * playerRadius);
            }
            playerCtx.stroke();
            playerCtx.fill();
        }));

        shotsCtx.fillStyle = 'black';
        socket.on('update shots', (shots) => requestAnimationFrame(() => {
            shotsCtx.beginPath();
            shotsCtx.clearRect(0, 0, shotsCanvas.width, shotsCanvas.height);

            for (const i in shots) {
                const shotPlayer = shots[i];
                shotPlayer.forEach(shot => {
                    shotsCtx.moveTo(shot.position.x + bulletRadius, shot.position.y);
                    shotsCtx.arc(shot.position.x, shot.position.y, bulletRadius, 0, pi2);
                });
            }
            shotsCtx.fill();
        }));

        const keysPressed = {}
        let mousePressed = false;
        let mousePos;
        document.body.addEventListener('keydown', (e) => {
            keysPressed[e.key] = true;
        });

        document.body.addEventListener('keyup', (e) => {
            delete keysPressed[e.key];
        });

        document.body.addEventListener('mousedown', (e) => {
            mousePressed = true;
            mousePos = {x: e.clientX, y: e.clientY};
        })

        socket.on('heartbeat', () => {
            if (mousePressed) {mousePressed = false; socket.emit('action1', mousePos);}
            for (const i in keysPressed) {
                if (i === 's') socket.emit('move down');
                else if (i === 'w') socket.emit('move up');
                else if (i === 'a') socket.emit('move left');
                else if (i === 'd') socket.emit('move right');
            }
        });
    </script>
</body>

</html>
